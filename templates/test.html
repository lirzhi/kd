<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Element-UI Example</title>
    <!-- 引入Element-UI的样式文件 -->
    <link rel="stylesheet" href="./element-ui.css">
</head>
<body>
    <div id="app">
        <!-- 整体容器 -->
  <el-container class="main-wrapper">
    <!-- 头部区域 -->
    <el-header class="system-header">
      <span class="system-title">审评系统</span>
    </el-header>

    <el-container class="content-wrapper">
      <!-- 侧边导航栏 -->
      <el-aside width="200px" class="nav-sidebar">
        <el-menu
          default-active="1"
          class="menu-container"
          @select="handleMenuSelect">
          <el-menu-item index="1">
            <i class="el-icon-document"></i>
            <span>报告生成</span>
          </el-menu-item>
          <el-menu-item index="2">
            <i class="el-icon-files"></i>
            <span>审批记录</span>
          </el-menu-item>
        </el-menu>
      </el-aside>

      <!-- 主内容区域 -->
      <el-main  class="main-content">
        <!-- 章节选择栏 -->
        <div class="chapter-selector">
          <el-select 
            v-model="selectedChapterIndex"
            placeholder="请选择章节"
            class="chapter-select">
            <el-option
              v-for="(chapter, index) in chapters"
              :key="index"
              :label="'第' + chapter.label + '章'"
              :value="index">
            </el-option>
          </el-select>
        </div>

        <!-- 双栏内容区域 -->
        <el-row class="card-container" :gutter="20">
          <!-- 左侧内容卡片 -->
          <el-col v-if="!isSourceView" :span="12">
            <el-card class="content-card">
              <div class="text-editor-container">
                <el-input
                  type="textarea"
                  v-model="chapters[selectedChapterIndex].content"
                  :rows="35"
                  placeholder="输入章节内容"
                  class="rounded-editor">
                </el-input>
              </div>
            </el-card>
          </el-col>

          <!-- 左侧内容卡片 -->
          <el-col v-else :span="12">
            <el-card class="content-card">
              <!-- 搜索栏 -->
                <div class="source-search">
                    <el-input
                    v-model="sourceSearchQuery"
                    placeholder="搜索结论来源"
                    @keyup.enter.native="searchSources"
                    clearable>
                    <el-button
                        slot="append"
                        icon="el-icon-search"
                        @click="searchSources">
                    </el-button>
                    </el-input>
                </div>

                <!-- 来源列表 -->
                <div class="source-list">
                    <el-card
                    v-for="(source, index) in filteredSources"
                    :key="index"
                    class="source-item">
                    <div class="source-header">
                        <span class="source-title">来源 {{ index + 1 }}</span>
                        <el-button
                        type="danger"
                        icon="el-icon-delete"
                        circle
                        @click="deleteSource(index)">
                        </el-button>
                    </div>

                    <div class="source-content">
                        <el-input
                        type="textarea"
                        :value="source.requirement"
                        :rows="3"
                        readonly
                        class="requirement-box">
                        </el-input>
                        <el-input
                        type="textarea"
                        v-model="source.conclusion"
                        :rows="4"
                        readonly
                        class="conclusion-box">
                        </el-input>
                    </div>
                    </el-card>
                </div>
            </el-card>
          </el-col>

          <!-- 右侧结论卡片 -->
          <el-col :span="12">
            <el-card class="conclusion-card">
                
                <div slot="header" class="report-header">
                    <span>审评报告</span>
                    <div>
                        <el-button 
                            type="primary" 
                            @click="generateConclusion(selectedChapterIndex)"
                            style="margin-left: 10px;">
                            生成报告
                        </el-button>
                        <el-button type="info" @click="showSource">结论来源</el-button>
                        <el-button type="warning" @click="showExpDialog">经验管理</el-button>
                        <el-button type="danger" @click="regenerate">重新生成</el-button>
                    </div>
                </div>
              
              <div class="conclusion-display">
                <el-input
                  type="textarea"
                  v-model="chapters[selectedChapterIndex].conclusion.content"
                  :rows="32"
                  readonly
                  class="rounded-display">
                </el-input>
              </div>
            </el-card>
          </el-col>
        </el-row>
      </el-main>
    </el-container>
  </el-container>
  <!-- 经验管理对话框 -->
  <el-dialog
    title="经验管理"
    :visible.sync="expDialogVisible"
    width="66%"
    top="5vh"
    :center="true"
    custom-class="exp-dialog">
    <div class="exp-dialog-content">
        <!-- 输入区域 -->
        <div class="input-section">
        <el-input
            v-model="newExperience"
            type="textarea"
            :rows="3"
            resize="vertical"
            placeholder="输入新经验"
            class="exp-textarea">
        </el-input>
        <div class="btn-container">
            <el-button 
            type="primary" 
            class="confirm-btn"
            @click="addExperience">
            添加经验
            </el-button>
        </div>
        </div>

    <!-- 经验列表 -->
    <div class="exp-list">
      <el-card 
        v-for="(exp, index) in experiences" 
        :key="index"
        class="exp-item">
        <div class="card-content">
          <el-input
            v-model="exp.content"
            type="textarea"
            resize="vertical"
            :autosize="{ minRows: 2 }"
            class="exp-content">
          </el-input>
          <div class="action-container">
            <el-button
              type="danger"
              icon="el-icon-delete"
              circle
              @click="deleteExperience(index)">
            </el-button>
          </div>
        </div>
      </el-card>
    </div>
  </div>
</el-dialog>
</div>

    <!-- 引入Vue.js -->
    <script src="./vue.js"></script>
    <!-- 引入Element-UI -->
    <script src="./element-ui.js"></script>
    <script>
        // 创建Vue实例
        new Vue({
            el: '#app',
            data() {
                return {
                    chapters: [
                        { 
                            label: '3.3.1', 
                            value: '3.3.1',
                            content: '初始内容...',
                            conclusion: {
                                content: '暂无结论',
                                references: [],
                                experiences: [],
                                rawData: null
                            }
                        },
                        // 其他章节...
                    ],
                    // 当前选中的章节索引
                    selectedChapterIndex: 0,
                    isSourceView: false,
                    sources: [],
                    expDialogVisible: false,
                    newExperience: '',
                    experiences: [],
                    showSearch: false,
                    currentReport: '',
                    sourceSearchQuery: '', // 来源搜索关键词
                    sources: [], // 原始来源数据
                    filteredSources: [] // 过滤后的来源数据

                }
            },

            created() {
                this.initChapters();
            },
            watch: {
                selectedChapterIndex() {
                this.loadSources()
                }
            },
            methods: {
                // 初始化章节数据
                initChapters() {
                    this.chapters = this.chapters.map(chapter => ({
                        ...chapter,
                        content: chapter.content || '暂无内容',
                        conclusion: {
                            content: '暂无结论',
                            references: [],
                            experiences: [],
                            rawData: null
                        }
                    }));
                },

                // 生成章节结论
                async generateConclusion(index) {
                    try {
                        const chapter = this.chapters[index];
                        const response = await fetch('http://127.0.0.1:5000/test', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({content: chapter.content})
                        });
                        
                        const data = await response.json();
                        if (data.code === 200) {
                            this.$set(this.chapters, index, {
                                ...chapter,
                                conclusion: {
                                    content: data.data.final_report,
                                    references: data.data.final_reference || [],
                                    experiences: chapter.conclusion.experiences,
                                    rawData: data.data
                                }
                            });
                            this.$message.success(`第${chapter.label}章结论生成成功`);
                        }
                    } catch (error) {
                        console.error('生成结论失败:', error);
                        this.$message.error('结论生成失败，请重试');
                    }
                },

                // 重新生成结论
                async regenerate() {
                    try {
                        const chapter = this.chapters[0]; // 假设只重新生成第一个章节的结论
                        const tempData = {
                            content: chapter.content,
                            original_report: chapter.conclusion.content,
                            content_split_reference_list: chapter.conclusion.references,
                            final_experience: chapter.conclusion.experiences,
                            content_split_conclusion_list: chapter.conclusion.rawData?.content_split_report_list || []
                        };

                        const response = await fetch('http://127.0.0.1:5000/regenerate_report', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ content: tempData })
                        });

                        const data = await response.json();
                        if (data.code === 200) {
                            this.$set(this.chapters, 0, {
                                ...chapter,
                                conclusion: {
                                    ...chapter.conclusion,
                                    content: data.data.report,
                                    rawData: {
                                        ...chapter.conclusion.rawData,
                                        final_report: data.data.report
                                    }
                                }
                            });
                            this.$message.success(`第${chapter.label}章结论重新生成成功`);
                        }
                    } catch (error) {
                        console.error('重新生成失败:', error);
                        this.$message.error('重新生成失败，请重试');
                    }
                },

                // 显示结论来源
                showSource() {
                    this.isSourceView = true;
                    // 模拟获取结论来源数据
                    this.sources = [
                        { requirement: '要求1', conclusion: '结论1' },
                        { requirement: '要求2', conclusion: '结论2' }
                    ];
                },

                // 返回主页面
                backToMain() {
                    this.isSourceView = false;
                },

                // 显示经验管理弹窗
                showExpDialog() {
                    this.expDialogVisible = true;
                },

                // 添加经验
                addExperience() {
                    if (this.newExperience.trim()) {
                        this.experiences.push({ content: this.newExperience });
                        this.newExperience = '';
                    }
                },

                // 删除经验
                deleteExperience(index) {
                    this.experiences.splice(index, 1);
                },

                // 切换搜索框显示
                toggleSearch() {
                    this.showSearch = !this.showSearch;
                },

                // 执行搜索
                doSearch() {
                    // 模拟搜索逻辑
                    this.$message.info(`搜索内容: ${this.searchQuery}`);
                },
                handleMenuSelect(index) {
                    // 处理菜单选择
                    if(index === '2') {
                        // 跳转审批记录页面
                    }
                },
                // 搜索来源
                async searchSources() {
                if (!this.sourceSearchQuery.trim()) {
                    this.filteredSources = [...this.sources]
                    return
                }

                try {
                    const response = await this.$http.post('/sources/search', {
                    query: this.sourceSearchQuery,
                    chapter: this.selectedChapterIndex + 1
                    })
                    
                    if (response.data.code === 200) {
                    this.filteredSources = response.data.data
                    }
                } catch (error) {
                    this.$message.error('搜索失败')
                }
                },

                // 删除来源
                async deleteSource(index) {
                try {
                    await this.$http.delete(`/sources/${this.filteredSources[index].id}`)
                    this.filteredSources.splice(index, 1)
                    this.sources = this.sources.filter(
                    s => s.id !== this.filteredSources[index].id
                    )
                    this.$message.success('删除成功')
                } catch (error) {
                    this.$message.error('删除失败')
                }
                },

                // 初始化来源数据
                async loadSources() {
                try {
                    const response = await this.$http.get(`/sources/${this.selectedChapterIndex}`)
                    if (response.data.code === 200) {
                    this.sources = response.data.data
                    this.filteredSources = [...this.sources]
                    }
                } catch (error) {
                    this.$message.error('加载来源数据失败')
                }
                }
            },
            }
        );
    </script>
    <style>
        /* 全局样式 */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .main-wrapper {
            height: 100vh;
            
            .system-header {
                background: #409EFF;
                display: flex;
                align-items: center;
                .system-title {
                color: white;
                font-size: 24px;
                font-weight: bold;
                }
            }

            .nav-sidebar {
                background: #f5f7fa;
                .menu-container {
                height: 100%;
                border-right: none;
                }
            }

            .main-content {
                padding: 20px;
                background: #f0f2f5;
                
                .chapter-selector {
                    margin-bottom: 20px;
                    .chapter-select {
                        width: 300px;
                    }
                }
                .report-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .card-container {
                    height: calc(100vh - 160px);
                    
                    .content-card,
                    .conclusion-card {
                        height: 100%;
                        border-radius: 12px;
                        box-shadow: 0 2px 12px 0 rgba(0,0,0,.1);
                        
                        ::v-deep .el-card__body {
                        height: calc(100% - 50px);
                        padding: 20px;
                        }
                    }

                .text-editor-container,
                .conclusion-display {
                    height: 90%;
                    .rounded-editor,
                    .rounded-display {
                    height: 100%;
                    textarea {
                        border-radius: 8px;
                        resize: none;
                    }
                    }
                }

                .button-group {
                    margin-bottom: 20px;
                    .action-btn {
                    margin-right: 10px;
                    border-radius: 6px;
                    padding: 12px 20px;
                    }
                }
                }
            }
            }
            .exp-dialog {
                height: 66vh;
                border-radius: 12px;
                
                ::v-deep .el-dialog__body {
                    height: calc(100% - 55px);
                    padding: 20px;
                }

                .exp-dialog-content {
                    height: 100%;
                    display: flex;
                    flex-direction: column;

                    .input-section {
                    margin-bottom: 20px;
                    .exp-textarea {
                        ::v-deep textarea {
                        border-radius: 8px;
                        min-height: 100px;
                        }
                    }
                    .btn-container {
                        text-align: center;
                        margin: 15px 0;
                        .confirm-btn {
                        width: 120px;
                        border-radius: 6px;
                        padding: 12px 24px;
                        }
                    }
                    }

                    .exp-list {
                        flex: 1;
                        overflow-y: auto;
                        .exp-item {
                            margin-bottom: 15px;
                            border-radius: 10px;
                            ::v-deep .el-card__body {
                            padding: 15px;
                            }
                            .card-content {
                            display: flex;
                            flex-direction: column;
                            height: 100%;
                            .exp-content {
                                ::v-deep textarea {
                                border-radius: 6px;
                                }
                            }
                            .action-container {
                                margin-top: 10px;
                                text-align: center;
                            }
                            }
                        }
                    }
                }
                }
    </style>
</body>
</html>