<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文档编辑界面</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
        }

        .container {
            width: 80%;
            margin: 40px auto;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .section-title {
            font-size: 28px;
            margin-bottom: 20px;
            color: #333333;
        }

        .section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .section div {
            border: 1px solid #e0e0e0;
            padding: 10px;
            width: 48%;
            box-sizing: border-box;
        }

        textarea {
            width: 100%;
            height: auto;
            min-height: 100px;
            max-height: 200px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
        }

        .button {
            padding: 8px 15px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .confirm-button {
            display: block;
            width: 120px;
            margin: 20px auto;
            padding: 10px;
            background-color: #28a745;
            color: #ffffff;
            text-align: center;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            right: 20px;
            top: 20px;
            width: 400px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .modal-content {
            padding: 20px;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333333;
        }

        .reference-item {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-button {
            background-color: transparent;
            color: #dc3545;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .delete-button:hover {
            color: #c82333;
        }

        .add-experience {
            display: block;
            width: 120px;
            margin: 20px auto;
            padding: 10px;
            background-color: #6c757d;
            color: #ffffff;
            text-align: center;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }


        .chapter-select {
            margin-bottom: 20px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            width: 100%;
            font-size: 14px;
        }

        .referenceModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            z-index: 2;
        }

        .referenceModalContent,
        .referenceSearch {
            width: 45%;
            /* 左右两部分各占45% */
            margin: 5% auto;
            /* 垂直居中 */
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .referenceList {
            overflow-y: auto;
        }

        .referenceItem {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .referenceDeleteButton {
            background-color: transparent;
            color: #dc3545;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .referenceDeleteButton:hover {
            color: #c82333;
        }


        #referenceInput {
            width: 80%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .referenceSearchButton {
            padding: 10px 15px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .referenceSearchButton:hover {
            background-color: #0056b3;
        }

        #referenceResult {
            width: 95%;
            min-height: 250px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            overflow-y: auto;
            resize: both;
        }

        .referenceActions {
            position: absolute;
            bottom: 20px;
            right: 20px;
        }

        .referenceAddButton,
        .searchReferenceShowButton,
        .referenceCancelButton,
        .referenceConfirmButton {
            display: block;
            width: 120px;
            margin: 20px auto;
            padding: 10px;
            background-color: #28a745;
            color: #ffffff;
            text-align: center;
            border: none;
            display: inline-block;
            margin: 0 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .referenceCancelButton {
            background-color: #836f71;
        }

        .add-reference {
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="section-title">xxx药品</div>
        <select class="chapter-select" onchange="changeChapter(this.value)">
            <option value="3.3.1">章节：3.3.1</option>
            <option value="3.3.2" selected>章节：3.3.2</option>
            <!-- 更多章节选项 -->
        </select>
        <div class="section">
            <div>
                <textarea id="paragraph1">暂无内容</textarea>
                <button class="button" onclick="generateConclusion('paragraph1')">生成结论</button>
                <textarea id="paragraph2">暂无内容</textarea>
                <button class="button" onclick="generateConclusion('paragraph2')">生成结论</button>
            </div>
            <div>
                <textarea id="review1">暂无内容</textarea>
                <button class="button" onclick="showReferences('review1')">结论来源</button>
                <button class="button" onclick="showExperience('review1')">经验管理</button>
                <button class="button" onclick="regenerateConclusion('review1')">重新生成</button>
                <textarea id="review2">暂无内容</textarea>
                <button class="button" onclick="showReferences('review2')">结论来源</button>
                <button class="button" onclick="showExperience('review2')">经验管理</button>
                <button class="button" onclick="regenerateConclusion('review2')">重新生成</button>
            </div>
        </div>
        <button class="confirm-button" onclick="confirmAction()">确认</button>
    </div>

    <!-- 参考文献 Modal -->
    <!-- 参考文献 Modal -->
    <div id="referenceModal" class="referenceModal">
        <div class="referenceModalContent">
            <div class="referenceList">
                <!-- 左侧依据列表 -->
                <div class="referenceItem">
                    <span>评审依据1</span>
                    <button class="referenceDeleteButton">删除</button>
                </div>
                <div class="referenceItem">
                    <span>评审依据2</span>
                    <button class="referenceDeleteButton">删除</button>
                </div>
            </div>
        </div>
        <div class="referenceSearch">
            <!-- 右侧搜索区域 -->
            <input type="text" id="referenceInput" placeholder="输入问题进行搜索...">
            <button class="referenceSearchButton" onclick="searchAI()">搜索</button>
            <textarea id="referenceResult" placeholder="搜索结果将显示在这里"></textarea>
            <div class="add-reference">
            </div>
        </div>
        <div class="referenceActions">
            <button class="referenceCancelButton" onclick="closeModal()">取消</button>
            <button class="referenceConfirmButton" onclick="confirmReference()">确认</button>
        </div>

    </div>

    <!-- 经验 Modal -->
    <div id="experienceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <!-- 这里将显示经验管理的内容 -->
        </div>
    </div>

    <script>
        reviewData = {};
        curSeachData = {};
        function changeChapter(value) {
            document.getElementById('chapterTitle').innerText = '章节：' + value;
        }

        function generateConclusion(paragraphId) {
            var paragraphContent = document.getElementById(paragraphId).value;
            fetch('http://127.0.0.1:5000/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: paragraphContent }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        console.log(data.data);
                        var reviewId = paragraphId.replace('paragraph', 'review'); // 根据paragraphId获取对应的reviewId
                        document.getElementById(reviewId).value = data.data.final_report;
                        reviewData[reviewId] = data;
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        function regenerateConclusion(reviewId) {
            var data = reviewData[reviewId];
            if (!data) {
                console.error('Error: 未找到对应的数据');
                return;
            }
            temp_data = {
                content: data.data.content,
                original_report: data.data.final_report,
                content_split_reference_list: data.data.final_reference,
                final_experience: data.data.experiences,
                content_split_conclusion_list: data.data.content_split_report_list,
            }
            fetch('http://127.0.0.1:5000/regenerate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: temp_data }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        console.log(data.data);
                        document.getElementById(reviewId).value = data.data.report;
                        reviewData[reviewId].final_report = data.data.report;
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });

        }

        function searchAI() {
            var question = document.getElementById('referenceInput').value;
            fetch('http://127.0.0.1:5000/test_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: question }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        console.log(data.data);
                        let combinedContent = data.data.response.map(item => item.content).join('\n');
                        document.getElementById('referenceResult').value = combinedContent;
                        curSeachData = data.data;
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        function showReferences(reviewId) {
            var backendResponse = reviewData[reviewId];
            console.log(backendResponse);
            if (!backendResponse) {
                console.error('Error: 未找到对应的数据');
                return;
            }
            if (backendResponse.code === 200 && backendResponse.data.content_split_report_list) {
                var referencesModalContent = '';
                backendResponse.data.content_split_report_list.forEach((items, outerIndex) => {
                    items.forEach((item, innerIndex) => {
                        // 保持原有的两层循环逻辑不变
                        referencesModalContent += `<div class="reference-item">
                    <textarea readonly onclick="showOriginalReference('${item.conclusion.reference}', '${reviewId}')">${item.conclusion.content}</textarea>
                    <button class="delete-button" onclick="deleteReference(this,'${reviewId}', '${outerIndex}')">删除</button>
                </div>`;
                    });
                });

                referenceActions = ` <button class="referenceCancelButton" onclick="closeModal()">取消</button><button class="referenceConfirmButton" onclick="confirmReference('${reviewId}')">确认</button>`;
                addAction = `
                <button class="searchReferenceShowButton" onclick="showCurReference()">内容参考</button>
                <button class="referenceAddButton" onclick="addToTrace('${reviewId}')">添加</button>
                `
                document.getElementById('referenceModal').querySelector('.referenceModalContent').innerHTML = referencesModalContent;
                document.getElementById('referenceModal').querySelector('.add-reference').innerHTML = addAction; // 隐藏搜索区域
                document.getElementById('referenceModal').querySelector('.referenceActions').innerHTML = referenceActions;
                document.getElementById('referenceModal').style.display = 'flex'; // 显示参考文献Modal
                if (curSeachData.query) {
                    document.getElementById('referenceInput').value = curSeachData.query;
                }
                if (curSeachData.response) {
                    combinedContent = data.data.response.map(item => item.content).join('\n');
                    document.getElementById('referenceResult').value = combinedContent;
                }
            } else {
                console.error('Error:', backendResponse.message);
            }
        }

        function showCurReference() {
            var referencesModalContent = '';
            curSeachData.response.forEach(item => {
                var referenceContent = curSeachData.reference[item.reference];
                referencesModalContent += `${item.content}\n参考文件: ${referenceContent ? referenceContent.file_name : '未找到参考信息'}\n\n`;
            });
            alert(referencesModalContent);
        }



        function showOriginalReference(reference, reviewId) {
            var data = reviewData[reviewId];
            if (!data) {
                alert('Error: data not found');
                return; // 退出整个函数
            }
            // 使用 for...of 循环代替 forEach
            for (const item of data.data.final_reference) {
                if (item.reference === reference) {
                    alert(item.content);
                    return; // 找到匹配项后退出整个函数
                }
            }
            // 如果循环结束后没有找到匹配项，执行以下代码
            alert("docid: " + reference); // 这里使用alert作为示例，您可以替换为其他显示方式
        }

        function addToTrace(reviewId) {
            var data = reviewData[reviewId];
            if (!data) {
                alert('Error: data not found');
                return; // 退出整个函数
            }
            var referenceContent = document.getElementById('referenceResult').value;
            var referenceItem = document.createElement('div');
            referenceItem.className = 'reference-item';
            index = 0;
            if (data.data.content_split_report_list) {
                index = data.data.content_split_report_list.length;
            }
            referenceItem.innerHTML = `<textarea>${referenceContent}</textarea>
            <button class="delete-button" onclick="deleteReference(this,'${reviewId}','${index}')">删除</button>`;
            document.getElementById('referenceModal').querySelector('.referenceModalContent').appendChild(referenceItem);
            // 更新reviewData对象
            if (!data.data.content_split_report_list) {
                data.data.content_split_report_list = [];
            }
            data.data.content_split_report_list.push([{ conclusion: { content: referenceContent } }]);
        }

        function deleteReference(button, reviewId, index) {
            var referenceItem = button.parentElement;
            referenceItem.remove();
            // 更新reviewData中对应的数据
            var backendResponse = reviewData[reviewId];
            if (backendResponse && backendResponse.data) {
                var itemToDelete = backendResponse.data.content_split_report_list[index][0];
                backendResponse.data.final_reference.forEach((item, refIndex) => {
                    if (item.reference === itemToDelete.conclusion.reference) {
                        backendResponse.data.final_reference.splice(refIndex, 1);
                    }
                });
                backendResponse.data.content_split_report_list.splice(index, 1, null);
            }
        }

        function confirmReference(reviewId) {
            var backendResponse = reviewData[reviewId];
            temp = []
            backendResponse.data.content_split_report_list.forEach((items, outerIndex) => {
                if (items != null) temp.push(items)
            });
            backendResponse.data.content_split_report_list = temp;
            closeModal(); // 关闭模态框
        }
        
        // 显示经验管理模态框的函数
        function showExperience(reviewId) {
            var backendResponse = reviewData[reviewId];
            if (!backendResponse) {
                console.error('Error: 未找到对应的数据');
                return;
            }
            var experienceModalContent = '<div class="experienceModalTab" style="display: flex; justify-content: space-between; margin-bottom: 10px;">'
                + `<button class="add-experience" onclick="addExperienceInput('${reviewId}')" style="margin-right: 5px;">添加经验</button>`
                + `<button class="confirm-button" onclick="confirmExperience('${reviewId}')" style="margin-left: 5px;">确认</button>`
                + '</div>';

            var experiencesExist = backendResponse.data.experiences && backendResponse.data.experiences.length > 0;
            if (experiencesExist) {
                backendResponse.data.experiences.forEach((item, index) => {
                    experienceModalContent += `<div class="experience-item" data-index="${index}">
                <textarea>${item || ''}</textarea>
                <button class="delete-button" onclick="deleteExperience(this,'${reviewId}', '${index}')">删除</button>
            </div>`;
                });
            }

            experienceModalContent = `<div class="experience-item" data-index="0">
            <textarea></textarea>
            </div>` + experienceModalContent;


            document.getElementById('experienceModal').querySelector('.modal-content').innerHTML = experienceModalContent;
            document.getElementById('experienceModal').style.display = 'block'; // 显示经验管理Modal
        }

        // 添加新经验输入框的函数
        function addExperienceInput(reviewId) {

            var lastInput = document.querySelectorAll('.experience-item textarea').item(item => item === lastInput[lastInput.length - 1]);
            if (lastInput.value.trim() === '') {
                alert('请先填写内容');
                return;
            }
            var experienceModalContent = document.getElementById('experienceModal').querySelector('.modal-content');
            var experienceItems = experienceModalContent.querySelectorAll('.experience-item');
            var newIndex = experienceItems.length;
            data = reviewData[reviewId].data.experiences;
            if (!data || data.length <= newIndex) {
                alert('请先保存当前内容');
                return;
            }
            experienceModalContent.innerHTML = `<div class="experience-item" data-index="${newIndex}">
        <textarea></textarea>
        <button class="delete-button" onclick="deleteExperience(this,'${reviewId}', '${newIndex}')">删除</button>
        </div>` + experienceModalContent.innerHTML;
        }

        // 确认经验管理输入并存储到reviewData对象中的函数
        function confirmExperience(reviewId) {
            var backendResponse = reviewData[reviewId];
            if (!backendResponse) {
                console.error('Error: 未找到对应的数据');
                return;
            }
            var userInputs = [];
            // 收集所有文本框中的用户输入
            document.querySelectorAll('.experience-item textarea').forEach(textarea => {
                if (textarea.value.trim() == '') return true;
                userInputs.push(textarea.value.trim());
            });
            // 更新reviewData对象
            if (!backendResponse.data.experiences) {
                backendResponse.data.experiences = [];
            }
            backendResponse.data.experiences = userInputs;
            // 可能还需要发送数据到服务器或其他存储
            closeModal(); // 关闭模态框
        }

        // 删除经验管理项的函数
        function deleteExperience(button, reviewId, index) {
            var referenceItem = button.parentElement;
            referenceItem.remove();
            // 更新reviewData中对应的数据
            var backendResponse = reviewData[reviewId];
            if (backendResponse && backendResponse.data && backendResponse.data.experiences) {
                backendResponse.data.experiences.splice(referenceItem.getAttribute('data-index'), 1, null);
            }
        }

        // 确保closeModal函数存在，用于关闭模态框和处理其他关闭逻辑
        function closeModal() {
            document.getElementById('referenceModal').style.display = 'none';
            document.getElementById('experienceModal').style.display = 'none';
            // 可以在这里添加其他关闭模态框时需要执行的逻辑
        }


        function confirmAction() {
            alert("确认操作");
        }

const eventSource = new EventSource('http://127.0.0.1:5000/stream_logs');

eventSource.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log('Received log:', data);
};

eventSource.onerror = (e) => {
    console.error('Error:', e);
    eventSource.close();
};
    </script>